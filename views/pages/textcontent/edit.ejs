<div class="d-flex flex-grow-1 flex-shrink-1 flex-wrap">
    <%- partial('../../partials/textcontent/app-nav.ejs'); %>
    <!-- TODO QNTM-63 -->
    <div class="flex-fill grey-background d-flex flex-row" role="dialog" id="editor">
        <form action="/dashboard/text/<%= textcontent.id; %>/update" method="post" class="flex-fill">
            <div class="d-flex flex-row align-items-center justify-content-between">
                <div class="pl-4 pt-3">
                    <h1>
                        {{ title }}
                    </h1>
                </div>
                <label class="mr-4 mb-0 px-3 py-2 shape-rounded-corners-small font-extra-small-text font-weight-bold"
                       v-bind:class="statusColor">
                    {{ contentStatus }}
                </label>
            </div>
            <div class="d-flex flex-wrap pt-3">
                <div class="flex-fill px-3">
                    <div class="bg-white shape-drop-shadow-straight shape-rounded-corners-big p-3 flex-grow-1 mb-4">
                        <div>
                            <input type="hidden" name="_csrf" value="<%= _csrf; %>"/>
                            <div class="font-weight-bold font-extra-small-text">
                                <label for="entryTitle">Title:</label>
                            </div>
                            <textarea class="form-control flex-grow-1" name="title" type="text" minlength="1"
                                      maxlength="80" id="entryTitle" cols="30" rows="1" required
                                      v-model="title" @input="changeStatus"></textarea>
                            <div class="mt-4 font-weight-bold font-extra-small-text">
                                <label for="entryContent">Content:</label>
                            </div>
                            <textarea class="form-control flex-grow-1" name="content" type="text" minlength="2"
                                      maxlength="1024" id="entryContent" cols="30" rows="15" required
                                      v-model="content" @input="changeStatus"></textarea>
                            <div class="invalid-feedback">Please enter your content.</div>
                        </div>
                    </div>
                </div>
                <div class="flex-fill px-3 app-info-column">
                    <div class="bg-white shape-drop-shadow-straight shape-rounded-corners-big p-3 justify-content-center mb-4">
                        <div class="d-flex flex-column">
                            <div>
                                <h4>Information</h4>
                            </div>
                            <div class="qntm-pricing-separator-line mb-2 pt-1"></div>
                            <div class="d-flex justify-content-between align-items-center align-content-center text-left app-info-text">
                                <span class="mr-2 font-extra-small-text font-weight-bold">Created:</span>
                                <span>{{ createdAt }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center align-content-center text-left app-info-text">
                                <span class="mr-2 font-extra-small-text font-weight-bold">Updated:</span>
                                <span>{{ updatedAt }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center align-content-center text-left app-info-text">
                                <span class="mr-2 font-extra-small-text font-weight-bold">Author:</span>
                                <span class="text-truncate">{{ author }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center align-content-center text-left app-info-text">
                                <span class="mr-2 font-extra-small-text font-weight-bold">Editor:</span>

                                <span class="text-truncate">
                                    {{ updatedFrom }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white shape-rounded-corners-big d-flex flex-column shape-drop-shadow-straight p-3">
                        <!-- TODO QTNM-40 tags -->
                        <div class="ml-1 font-extra-small-text font-weight-bold float-left">
                            <label class="mb-1">Tags:</label>
                        </div>
                        <div class="d-flex flex-row flex-wrap w-100" style="height: 90px">
                            <% textcontent.tags.forEach(function(entry){ %>
                                <a href="/dashboard/tag/motorsports"
                                   class="d-flex border px-2 mr-1 mt-1 shape-rounded-corners-big align-items-center flex-nowrap app-tag-container">
                                        <span class="font-extra-small-text font-weight-bold"
                                              style="color: <%= entry.colour %>">●</span>
                                    <span class="px-1 font-extra-small-text font-weight-bold"><%= entry.name %>></span>
                                    <span class="font-extra-small-text font-weight-bold app-tag-close-button shape-rounded-corners-big"></span>
                                </a>
                            <% }); %>
                            <a href="/dashboard/tag/motorsports"
                               class="d-flex border px-2 mr-1 mt-1 shape-rounded-corners-big align-items-center flex-nowrap app-tag-container">
                                <span class="font-extra-small-text font-weight-bold"
                                      style="color: lightseagreen">●</span>
                                <span class="px-1 font-extra-small-text font-weight-bold text-truncate"
                                      style="max-width: 100px">Motorsports</span>
                                <span class="font-extra-small-text font-weight-bold app-tag-close-button shape-rounded-corners-big"></span>
                            </a>
                            <a href="/dashboard/tag/motorsports"
                               class="d-flex border px-2 mr-1 mt-1 shape-rounded-corners-big align-items-center flex-nowrap app-tag-container">
                                <span class="font-extra-small-text font-weight-bold"
                                      style="color: lightseagreen">●</span>
                                <span class="px-1 font-extra-small-text font-weight-bold text-truncate"
                                      style="max-width: 100px">Motorsports</span>
                                <span class="font-extra-small-text font-weight-bold app-tag-close-button shape-rounded-corners-big"></span>
                            </a>
                            <a href="/dashboard/tag/new" id="app-tag-add-container"
                               class="d-flex border px-2 mr-1 mt-1 shape-rounded-corners-big align-items-center flex-nowrap">
                                <span class="font-extra-small-text font-weight-bold">+</span>
                            </a>
                        </div>
                        <!-- TODO QNTM-69 Text Versioning -->
                        <div class="dropdown my-3">
                            <button class="qntm-primary-button grey-background w-100 shape-rounded-corners-small border dropdown-toggle font-special-text font-extra-small-text grey-font"
                                    type="button" id="dropdownMenuButton" data-toggle="dropdown"
                                    aria-haspopup="true" aria-expanded="false">
                                Retrieve older versions
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                <% if (textcontent.oldversions.length > 0) { %>
                                    <% textcontent.oldversions.forEach(function(entry){ %>
                                        <!-- TODO QNTM-69 Text Versioning: convert date into readable format -->
                                        <a href="#" class="grey-font dropdown-item text-center">
                                            <%= entry.updatedAt; %>
                                        </a>
                                    <% }); %>
                                <% } else { %>
                                    <span class="my-2 py-3 px-2 grey-font font-extra-small-text font-weight-bold">No other versions available</span>
                                <% } %>
                            </div>
                        </div>
                        <div class="ml-1 font-extra-small-text font-weight-bold float-left">
                            <label for="entry_endpoint" class="mb-1">Endpoint:</label>
                        </div>
                        <div class="d-flex flex-column justify-content-center align-items-center">
                            <div class="mb-2 d-flex align-items-center grey-background border shape-rounded-corners-small"
                                 id="entry_endpoint_container">
                                <textarea name="endpoint" type="text" id="entry_endpoint"
                                          cols="30" rows="1"
                                          class="text-truncate font-extra-small-text border-0 mr-2 grey-background"
                                          readonly><%= textcontent.endpoint; %></textarea>
                                <img src="/images/icon-copy.svg" alt="Copy to clipboard"
                                     id="app-copy-button-icon"
                                     class="d-inline-block flex-shrink-0 mr-1 qntm-icon-button">
                            </div>
                            <div class="d-flex align-items-center align-content-center mt-2">
                                <div class="d-flex align-items-center">
                                    <span class="font-extra-small-text font-weight-bold ml-2 mr-3">Delete?</span>
                                    <div class="material-switch pull-right">
                                        <input id="app-delete-confirmation" name="delete-switch" type="checkbox"
                                        />
                                        <label for="app-delete-confirmation" class="label-danger"></label>
                                    </div>
                                </div>
                                <div class="ml-3 mr-1">
                                    <a href="/dashboard/text/<%= textcontent.id; %>/destroy" id="app-delete-button"
                                       class="qntm-primary-button qntm-secondary-button shape-rounded-corners-small font-special-text border-0">Delete</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-around align-content-center align-items-center my-4">
                        <div>
                            <button class="qntm-primary-button shape-rounded-corners-small font-special-text border-0"
                                    type="submit" @click="update">
                                Save
                            </button>
                        </div>
                        <div>
                            <button class="qntm-primary-button qntm-secondary-button shape-rounded-corners-small font-special-text border-0"
                                    type="button" @click="reset">
                                Revert
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <script>
      window.onload = () => {
        let app = new Vue({
          el: '#editor',
          data: {
            id: '<%= textcontent.id; %>',
            title: '<%= textcontent.title; %>',
            originalTitle: '<%= textcontent.title; %>',
            content: '<%= textcontent.content; %>',
            originalContent: '<%= textcontent.content; %>',
            createdAt: '<%= textcontent.createdAt; %>',
            updatedAt: '<%= textcontent.updatedAt; %>',
            author: '<%= textcontent.author.fullName; %>',
            updatedFrom: "<% if (textcontent.updatedFrom != null) { %><%= textcontent.updatedFrom.fullName; %><% } else { %>–<% } %>",
            archivedTitle: '<%= textcontent.oldversions; %>',
            contentStatus: '✓ published',
            statusColor: 'editor-status-saved',
          },
          methods: {
            update: function () {
              contentStatus = '✓ published';
              statusColor = 'editor-status-saved';
            },
            reset: function () {
              this.title = this.originalTitle;
              this.content = this.originalContent;
            },
            changeStatus: function () {
              if (this.title !== this.originalTitle || this.content !== this.originalContent) {
                this.contentStatus = '⚠ unpublished changes';
              } else {
                this.contentStatus = '✓ published';
              }
            }
          },
          /* executes this function when Vue if fully loaded */
          mounted() {
            /* Converts a JS timestamp from milliseconds to readable time format */
            const convertDate = (date) => {
              let ISODate = new Date(date);

              let day = ISODate.getDate();
              let month = ISODate.getMonth() + 1;
              let year = ISODate.getFullYear();
              let hour = ISODate.getHours();
              let min = ISODate.getMinutes();

              // adds leading zero
              month = (month < 10 ? '0' : '') + month;
              day = (day < 10 ? '0' : '') + day;
              hour = (hour < 10 ? '0' : '') + hour;
              min = (min < 10 ? '0' : '') + min;

              return day + '/' + month + '/' + year + ' ' + hour + ':' + min;
            };

            this.createdAt = convertDate(parseInt(this.createdAt));
            this.updatedAt = convertDate(parseInt(this.updatedAt));
          }
        });
      }
      ;
    </script>
</div>
